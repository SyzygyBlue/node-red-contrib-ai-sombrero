<script type="text/html" data-template-name="llm-connector">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name">
  </div>
  
  <div class="form-row">
    <label for="node-config-input-llmConfig"><i class="fa fa-cog"></i> LLM Configuration</label>
    <div style="display: flex; align-items: center;">
      <input type="text" id="node-config-input-llmConfig" style="flex: 1; margin-right: 5px;">
      <button type="button" id="node-config-test-connection" class="editor-button" style="white-space: nowrap;">
        <i class="fa fa-plug"></i> Test Connection
      </button>
    </div>
    <div id="node-config-connection-status" class="node-status-dot" style="display: none; margin-top: 5px;">
      <i class="fa fa-circle"></i> <span>Status</span>
    </div>
  </div>
  
  <div class="form-row">
    <label for="node-config-input-prompt">
      <i class="fa fa-comment"></i> Prompt 
      <span class="node-help" title="Enter your prompt or use the enhance button to improve it">
        <i class="fa fa-question-circle"></i>
      </span>
    </label>
    <div style="display: flex; width: 100%;">
      <textarea id="node-config-input-prompt" style="flex: 1; height: 100px; resize: vertical; font-family: monospace;" 
                placeholder="Enter your prompt here or use the enhance button"></textarea>
      <div style="display: flex; flex-direction: column; margin-left: 5px;">
        <button type="button" id="node-config-enhance-prompt" class="editor-button" style="margin-bottom: 5px; height: 48px;">
          <i class="fa fa-magic"></i> Enhance
        </button>
        <button type="button" id="node-config-insert-variable" class="editor-button" style="height: 48px;">
          <i class="fa fa-code"></i> Insert Variable
        </button>
      </div>
    </div>
  </div>
  
  <div class="form-row">
    <label for="node-config-input-role">
      <i class="fa fa-user"></i> Role 
      <span class="node-help" title="Select a predefined role template">
        <i class="fa fa-question-circle"></i>
      </span>
    </label>
    <div style="display: flex; align-items: center;">
      <select id="node-config-input-role" style="flex: 1; margin-right: 5px;">
        <option value="assistant">Loading roles...</option>
      </select>
      <button type="button" id="node-config-edit-role" class="editor-button" style="white-space: nowrap;">
        <i class="fa fa-edit"></i> Edit
      </button>
    </div>
  </div>
  
  <div class="form-row">
    <label for="node-config-input-context">
      <i class="fa fa-file-text"></i> Context 
      <span class="node-help" title="Additional context for the LLM">
        <i class="fa fa-question-circle"></i>
      </span>
    </label>
    <textarea id="node-config-input-context" style="width: 100%; height: 60px; resize: vertical;"
              placeholder="Optional: Add any additional context for the LLM"></textarea>
  </div>
  
  <div class="form-row">
    <label for="node-config-input-debug">
      <input type="checkbox" id="node-config-input-debug" style="display: inline-block; width: auto; vertical-align: top;">
      <span>Enable debug mode</span>
    </label>
  </div>
  
  <div class="form-row debug-options" style="display: none;">
    <label for="node-options-group"><i class="fa fa-cog"></i> Advanced Options (JSON)</label>
    <div id="node-options-group" style="height: 150px;"></div>
    <input type="hidden" id="node-input-options">
  </div>
  
  <div class="form-tips">
    <p><i class="fa fa-info-circle"></i> This node processes messages using the specified LLM provider and role template.</p>
    <p><i class="fa fa-arrow-right"></i> Outputs to the first output on success, or the second output on error.</p>
    <p><i class="fa fa-lightbulb-o"></i> <strong>Tip:</strong> Use the Enhance button to improve your prompt with AI assistance.</p>
  </div>
  
  <!-- Container for the prompt enhancer UI -->
  <div id="node-prompt-enhancer-container"></div>
  
  <!-- Container for the role editor -->
  <div id="node-role-editor" class="node-dialog" style="display: none;">
    <div class="form-row">
      <label for="role-editor-name">Role Name</label>
      <input type="text" id="role-editor-name" style="width: 100%;">
    </div>
    <div class="form-row">
      <label for="role-editor-description">Description</label>
      <textarea id="role-editor-description" style="width: 100%; height: 60px;"></textarea>
    </div>
    <div class="form-row">
      <label for="role-editor-instructions">Instructions</label>
      <textarea id="role-editor-instructions" style="width: 100%; height: 120px; font-family: monospace;"></textarea>
    </div>
  </div>
  
  <style>
    .node-help {
      color: #999;
      margin-left: 5px;
      cursor: help;
    }
    .node-status-dot {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
    }
    .node-status-dot .fa-circle {
      margin-right: 5px;
    }
    .status-connected {
      color: #3c763d;
      background-color: #dff0d8;
    }
    .status-disconnected {
      color: #a94442;
      background-color: #f2dede;
    }
    .status-connecting {
      color: #8a6d3b;
      background-color: #fcf8e3;
    }
  </style>
</script>

<script type="text/javascript">
  'use strict';
  
  RED.nodes.registerType('llm-connector', {
    category: 'AI/LLM',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      llmConfig: { type: 'llm-config', required: true },
      prompt: { value: '' },
      context: { value: '' },
      role: { value: 'assistant' },
      debug: { value: false },
      options: { value: '{}', validate: RED.validators.json() }
    },
    inputs: 1,
    outputs: 2,
    icon: 'font-awesome/fa-plug',
    label: function () {
      return this.name || 'LLM Connector';
    },
    oneditprepare: function() {
      const node = this;
      
      // Initialize the config node selector
      const llmConfigInput = $('#node-config-input-llmConfig').typedInput({
        types: [
          {
            value: 'llm-config',
            label: 'LLM Config',
            type: 'node:llm-config'
          }
        ],
        typeField: 'type',
        type: 'llm-config'
      });
      
      // Set initial value if exists
      if (node.llmConfig) {
        llmConfigInput.typedInput('value', node.llmConfig);
      }
      
      // Test connection button handler
      $('#node-config-test-connection').on('click', function() {
        const configNodeId = llmConfigInput.typedInput('value');
        if (!configNodeId) {
          updateConnectionStatus('Please select an LLM Config node', 'status-disconnected');
          return;
        }
        
        const configNode = RED.nodes.node(configNodeId);
        if (!configNode) {
          updateConnectionStatus('Selected config node not found', 'status-disconnected');
          return;
        }
        
        updateConnectionStatus('Testing connection...', 'status-connecting');
        
        // Call the test method on the config node
        $.ajax({
          url: `llm-config/${configNodeId}/test`,
          type: 'POST',
          data: JSON.stringify({}),
          contentType: 'application/json'
        }).done(function(response) {
          if (response.valid) {
            updateConnectionStatus(`Connected to ${configNode.model || 'LLM'}`, 'status-connected');
          } else {
            updateConnectionStatus('Connection failed: ' + (response.message || 'Unknown error'), 'status-disconnected');
          }
        }).fail(function(xhr, status, error) {
          updateConnectionStatus('Connection error: ' + (xhr.responseJSON?.message || error), 'status-disconnected');
        });
      });
      
      // Update connection status display
      function updateConnectionStatus(message, statusClass) {
        const statusEl = $('#node-config-connection-status');
        statusEl.find('span').text(message);
        statusEl.removeClass('status-connected status-disconnected status-connecting')
                .addClass(statusClass)
                .show();
      }
      
      // Load available roles
      function loadRoles() {
        $.getJSON('llm-roles')
          .done(function(roles) {
            const roleSelect = $('#node-config-input-role');
            roleSelect.empty();
            
            if (!roles || roles.length === 0) {
              roleSelect.append($('<option>', {
                value: 'assistant',
                text: 'Assistant (default)'
              }));
            } else {
              roles.forEach(function(role) {
                roleSelect.append($('<option>', {
                  value: role.id,
                  text: role.name || role.id,
                  'data-description': role.description || ''
                }));
              });
            }
            
            // Set the selected role if it exists
            if (node.role) {
              roleSelect.val(node.role);
            }
            
            // Show role description on hover
            roleSelect.on('mouseenter', 'option', function() {
              const desc = $(this).data('description');
              if (desc) {
                // Show tooltip or update a description element
                $('#node-role-description').text(desc).show();
              }
            }).on('mouseleave', 'option', function() {
              $('#node-role-description').hide();
            });
          })
          .fail(function() {
            $('#node-config-input-role').html('<option value="assistant">Assistant (default)</option>');
          });
      }
      
      // Initial load of roles
      loadRoles();
      
      // Edit role button handler
      $('#node-config-edit-role').on('click', function() {
        const roleId = $('#node-config-input-role').val();
        const dialog = $('#node-role-editor').dialog({
          title: roleId === 'assistant' ? 'New Role' : 'Edit Role',
          modal: true,
          width: '80%',
          buttons: [
            {
              text: 'Save',
              click: function() {
                // Save role logic here
                dialog.dialog('close');
              }
            },
            {
              text: 'Cancel',
              click: function() {
                dialog.dialog('close');
              }
            }
          ]
        });
      });
      
      // Insert variable button handler
      $('#node-config-insert-variable').on('click', function() {
        const textarea = $('#node-config-input-prompt')[0];
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const before = text.substring(0, start);
        const after = text.substring(end, text.length);
        const variable = '{{variable}}';
        
        textarea.value = before + variable + after;
        textarea.selectionStart = textarea.selectionEnd = start + variable.length;
        textarea.focus();
      });
      
      // Toggle debug options
      $('#node-config-input-debug').on('change', function() {
        $('.debug-options').toggle(this.checked);
      }).trigger('change');
      
      // Initialize JSON editor for options
      const optionsEditor = new JSONEditor($('#node-options-group')[0], {
        mode: 'code',
        modes: ['code', 'form', 'text', 'tree', 'view'],
        onChange: function() {
          try {
            const json = optionsEditor.get();
            $('#node-input-options').val(JSON.stringify(json));
          } catch (e) {
            // Invalid JSON, will be caught by validation
          }
        }
      });
      
      // Load existing options
      try {
        const options = JSON.parse(node.options || '{}');
        optionsEditor.set(options);
      } catch (e) {
        console.error('Error parsing options:', e);
        optionsEditor.set({});
      }
      
      // Initialize prompt enhancer if available
      initPromptEnhancer();
      
      // Helper to initialize the prompt enhancer UI
      function initPromptEnhancer() {
        try {
          const enhancerUI = RED.require('node-red-contrib-llm/nodes/shared/prompt-enhancer/ui');
          if (enhancerUI) {
            // Initialize the enhancer UI in the container
            const enhancer = enhancerUI.init($('#node-prompt-enhancer-container')[0], {
              theme: RED.settings.theme('base') || 'default',
              onEnhance: function(enhancedPrompt) {
                $('#node-config-input-prompt').val(enhancedPrompt).trigger('change');
              },
              onError: function(error) {
                console.error('Prompt enhancement error:', error);
                RED.notify('Failed to enhance prompt: ' + (error.message || 'Unknown error'), 'error');
              }
            });
            
            // Handle the enhance button click
            $('#node-config-enhance-prompt').on('click', function() {
              const currentPrompt = $('#node-config-input-prompt').val() || '';
              const context = $('#node-config-input-context').val() || '';
              const role = $('#node-config-input-role').val();
              
              enhancer.open({
                prompt: currentPrompt,
                context: context,
                role: role,
                configNodeId: llmConfigInput.typedInput('value')
              });
            });
          } else {
            // Hide enhance button if enhancer UI is not available
            $('#node-config-enhance-prompt').parent().hide();
          }
        } catch (error) {
          console.error('Error initializing prompt enhancer UI:', error);
          $('#node-config-enhance-prompt').parent().hide();
        }
      }
    },
    oneditsave: function() {
      // Ensure options are valid JSON
      try {
        JSON.parse($('#node-input-options').val() || '{}');
        return true;
      } catch (e) {
        RED.notify('Invalid JSON in options', 'error');
        return false;
      }
    },
    oneditresize: function(size) {
      // Handle dialog resizing
      const height = size.height - 100; // Account for header/footer
      $('.form-row textarea').css('height', Math.max(60, height * 0.3) + 'px');
      $('#node-options-group').css('height', Math.max(100, height * 0.4) + 'px');
    }
  });
  
  // Add the node to the palette
  RED.palette.createCategory('Sombrero-AI', {
    label: 'Sombrero-AI',
    color: '#a6bbcf',
    icon: 'font-awesome/fa-robot',
    nodes: [
      { type: 'llm-connector', label: 'LLM Connector',
        paletteLabel: 'LLM Connector',
        description: 'Connect to various LLM providers with a unified interface',
        inputs: 1,
        outputs: 2,
        icon: 'font-awesome/fa-robot',
        color: '#a6bbcf',
        align: 'left'
      }
    ]
  });
</script>

<!-- Help text for the node -->
<script type="text/html" data-help-name="llm-connector">
  <p>Connects to an LLM provider using a configuration from an LLM Config node.</p>
  <p><b>Inputs</b>: Messages to send to the LLM</p>
  <p><b>Output 1</b>: LLM response</p>
  <p><b>Output 2</b>: Error information if the request fails</p>
  <p><b>Configuration</b>:</p>
  <ul>
    <li><b>Name</b>: Optional name for the node</li>
    <li><b>LLM Config</b>: Select an LLM Config node with provider settings</li>
    <li><b>Role</b>: The role to use for the LLM (e.g., assistant, summarizer)</li>
    <li><b>Debug</b>: Enable to include additional debug information in the output</li>
  </ul>
</script>
